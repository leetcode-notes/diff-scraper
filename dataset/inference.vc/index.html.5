<!doctype html>
<html lang="en">
	<head>
	    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
	    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	    <title>The Spherical Kernel Divergence</title>
	    <meta name="description" content="" />
	    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,700italic,300,700' rel='stylesheet' type='text/css'>
		<link href='http://fonts.googleapis.com/css?family=Bree+Serif' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" type="text/css" href="/assets/styles/crisp.css?v=a4a8b7e06d">
		<link rel="shortcut icon" href="/content/images/2014/Mar/face.png"/>
	    <meta name="HandheldFriendly" content="True" />
	    <meta name="MobileOptimized" content="320" />
	    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
		<!--[if lt IE 9]>
			<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
			<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
		<![endif]-->
	    <link rel="canonical" href="http://www.inference.vc/the-spherical-kernel-divergence/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="http://www.inference.vc/the-spherical-kernel-divergence/amp/" />
    
    <meta property="og:site_name" content="inFERENCe" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="The Spherical Kernel Divergence" />
    <meta property="og:description" content="This post is about an interesting kernel-based divergence measure I found when I wrote up my thesis on scoring rules and divergences in machine learning. It&#x27;s been largely forgotten, I&#x27;m not aware of this being discussed elsewhere. I thought I&#x27;ll put it out here in case people find it useful." />
    <meta property="og:url" content="http://www.inference.vc/the-spherical-kernel-divergence/" />
    <meta property="og:image" content="http://www.inference.vc/content/images/2017/03/Screen-Shot-2017-03-09-at-4.58.39-PM.png" />
    <meta property="article:published_time" content="2017-03-09T13:51:11.000Z" />
    <meta property="article:modified_time" content="2017-03-09T16:58:56.000Z" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="The Spherical Kernel Divergence" />
    <meta name="twitter:description" content="This post is about an interesting kernel-based divergence measure I found when I wrote up my thesis on scoring rules and divergences in machine learning. It&#x27;s been largely forgotten, I&#x27;m not aware of this being discussed elsewhere. I thought I&#x27;ll put it out here in case people find it useful." />
    <meta name="twitter:url" content="http://www.inference.vc/the-spherical-kernel-divergence/" />
    <meta name="twitter:image" content="http://www.inference.vc/content/images/2017/03/Screen-Shot-2017-03-09-at-4.58.39-PM.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Ferenc Huszar" />
    <meta name="twitter:site" content="@fhuszar" />
    <meta property="og:image:width" content="1454" />
    <meta property="og:image:height" content="760" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "inFERENCe",
        "logo": "http://www.inference.vc/content/images/2014/Mar/face.png"
    },
    "author": {
        "@type": "Person",
        "name": "Ferenc Huszar",
        "image": "//www.gravatar.com/avatar/943e71b49d8fa0b3725fa6c82c97163d?d=404",
        "url": "http://www.inference.vc/author/ferenc-huszar/",
        "sameAs": []
    },
    "headline": "The Spherical Kernel Divergence",
    "url": "http://www.inference.vc/the-spherical-kernel-divergence/",
    "datePublished": "2017-03-09T13:51:11.000Z",
    "dateModified": "2017-03-09T16:58:56.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "http://www.inference.vc/content/images/2017/03/Screen-Shot-2017-03-09-at-4.58.39-PM.png",
        "width": 1454,
        "height": 760
    },
    "description": "This post is about an interesting kernel-based divergence measure I found when I wrote up my thesis on scoring rules and divergences in machine learning. It&#x27;s been largely forgotten, I&#x27;m not aware of this being discussed elsewhere. I thought I&#x27;ll put it out here in case people find it useful.",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://www.inference.vc"
    }
}
    </script>

    <meta name="generator" content="Ghost 0.11" />
    <link rel="alternate" type="application/rss+xml" title="inFERENCe" href="http://www.inference.vc/rss/" />
    <script src="//load.sumome.com/" data-sumo-site-id="a378ae33aa68caa37662d339c31c409600c8a85e240c12fceaeb0c70684208c0" async="async"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-96562474-1', 'auto');
  ga('send', 'pageview');

</script>
		<script>
			!function(g,s,q,r,d){r=g[r]=g[r]||function(){(r.q=r.q||[]).push(
			arguments)};d=s.createElement(q);q=s.getElementsByTagName(q)[0];
			d.src='//d1l6p2sc9645hc.cloudfront.net/tracker.js';q.parentNode.
			insertBefore(d,q)}(window,document,'script','_gs');

			_gs('GSN-053712-R');
		</script>
	</head>
	<body class="post-template">
		<header id="header">
			<a id="logo" href="http://www.inference.vc"><img src="/content/images/2014/Mar/face.png" alt="inFERENCe" /></a>
			<h1><a href="http://www.inference.vc">inFERENCe</a></h1>
			<p>posts on machine learning, statistics, opinions on things I&#x27;m reading in the space</p>
			<h6><a href="http://www.inference.vc/about">About</a></h6>
		</header>
		<main id="content">
			<article id="102" class="post">
    <span class="post-stamp">March 9th, 2017</span>
    <h1 class="post-title">The Spherical Kernel Divergence</h1>
    <p>This post is about an interesting kernel-based divergence measure I found when I wrote up <a href="https://github.com/fhuszar/thesis/blob/master/submitted/thesis.pdf">my thesis on scoring rules and divergences in machine learning</a>. It's been largely forgotten, I'm not aware of this being discussed elsewhere. I thought I'll put it out here in case people find it useful.</p>

<h1 id="background">Background</h1>

<h4 id="scoringrulesanddivergences">Scoring rules and divergences</h4>

<p>Scoring rules are best described in terms of forecasting: Let's assume we want to forecast some - so far unobserved - quantity $x$. We can summarise our forecast as a probability distribution $Q$ over possible outcomes. A scoring rule $S(x,Q)$ assigns a penalty to our probabilistic forecast $Q$ in the light of the actual observation $x$.</p>

<p>A common scoring rule in machine learning is the log loss: $S_{\log}(x,Q) = - \log Q(x)$. When one does maximum likelihood training of $Q$, that boils down to minimising the expected score $\operatorname{argmin}_\theta \mathbb{E}_{x\sim P}S_{\log}(x,Q_\theta)$. But the logarithmic is just one of many useful examples of scoring rules.</p>

<p>Based on a scoring rule $S$ one can define a divergence, which, under some conditions, is a <em>Bregman divergence</em>:</p>

<p>$$
d_S(P,Q) = \mathbb{E}_{x\sim P}S(x,Q) - \mathbb{E}_{x\sim P}S(x,P) <br />
$$</p>

<p>The scoring rule is called strictly proper, and the corresponding divergence a Bregman divergence, if and only if the following holds:</p>

<p>$$
d(P,Q)=0 \iff P=Q <br />
$$</p>

<p>So strictly proper scoring rules are useful, because minimising the average score over some dataset allows us to consistently recover the true data distribution $P$, as long as our model class $Q$ contains $P$.</p>

<p>For the logarithmic score, the corresponding divergence is the KL-divergence</p>

<p>$$
\operatorname{KL}[P\|Q] = \mathbb{E}_{x\sim P}\log\frac{P(x)}{Q(x)}
$$</p>

<p>There are many other useful scoring rules, and corresponding divergences, for a review see <a href="https://www.cs.duke.edu/courses/spring17/compsci590.2/Gneiting2007jasa.pdf">(Gneiting &amp; Raftery, 2007)</a> or chapter 1 of <a href="https://github.com/fhuszar/thesis/blob/master/submitted/thesis.pdf">my thesis</a>.</p>

<p>Finally, here is a lighthearted, graphical illustration of Bregman divergences, in terms of the entropy function $\mathbb{H}_S[Q] = \mathbb{E}_{x\sim Q}S(x,Q)$:</p>

<p><img src="/content/images/2017/03/Screen-Shot-2017-03-09-at-1.46.17-PM.png" alt="" /></p>

<h5 id="maximummeandiscrepancyandthekernelscoringrule">Maximum mean discrepancy and the kernel scoring rule</h5>

<p>I'm going to show another divergence, maximum mean discrepancy (MMD), and the associated <em>kernel scoring rule</em>. MMD is used in two-sample testing, and more recently in Generative Moment Matching Networks (<a href="https://arxiv.org/abs/1502.02761">Li et al, (2016)</a>, <a href="https://arxiv.org/abs/1505.03906">Dziugaite et al. (2016)</a>) for generative modelling.</p>

<p>\begin{align}
\operatorname{MMD}^2(x,y) &amp;= \sup_{\|f\|_{\mathcal{H}_k}=1} \left( \mathbb{E}_{x\sim P}f(x) - \mathbb{E}_{x\sim Q}f(x) \right)^2\\
&amp;= \|\mu_P - \mu_Q\|_{\mathcal{H}_k}^2\\
&amp;= \mathbb{E}_{x,y\sim P} k(x,y) + \mathbb{E}_{x,y\sim Q} k(x,y) - 2 \mathbb{E}_{x\sim P,y\sim Q} k(x,y)
\end{align}</p>

<p>The first line explains why this divergence is called Maximum Mean Discrepancy: it finds the worst-case function $f$ (from the unit ball of the Hilbert-space, $\|f\|_{\mathcal{H}_k}=1$) whose average value under $P$ is most different from its average under $Q$. In this sense, $f$ plays a similar role to the adversarial discriminator in GANs: it's trying to characterise the differences between $P$ and $Q$.</p>

<p>The second line is the definition in terms of the so called <em>mean embeddings</em>: the functions $\mu_P = \mathbb{E}_{x\sim P}k(\cdot,x)$ and $\mu_Q = \mathbb{E}_{x\sim Q}k(\cdot,x)$ in the Hilbert space which uniquely characterise $P$ and $Q$, respectively.</p>

<p>The third line expresses MMD in terms of the kernel function $k$, and this is the formula we use when we actually want to compute this divergence.</p>

<p>The squared MMD is in fact a Bregman divergernce which corresponds to the <em>kernel scoring rule</em>, defined as follows:</p>

<p>\begin{align}
S_k(x,Q) &amp;= k(x,x) - 2\mathbb{E}_{y\sim Q}k(x,y) + \mathbb{E}_{y,z\sim Q}k(y,z)\\ <br />
    &amp;= \sup_{\|f\|_{\mathcal{H}_k}=1} (f(x) - \mathbb{E}_{y\sim Q} f(y))^2\\
    &amp;= \|k(\cdot,x) - \mu_Q\|_{\mathcal{H}_k}^2\\
    &amp;= MMD^2(\delta_x, Q)
\end{align}</p>

<p>What is interesting about this scoring rule is that you can view it as the kernel generalisation of the ancient Brier scoring rule (<a href="https://docs.lib.noaa.gov/rescue/mwr/078/mwr-078-01-0001.pdf">Brier, 1950</a>. <a href="http://amstat.tandfonline.com/doi/abs/10.1198/016214506000001437">Gneiting &amp; Raftery, 2017</a>) which measures $L_2$ norm rather than RKHS-norm:</p>

<p>\begin{align}
S_{Brier}(x,Q)&amp;= \|\delta_x - Q \|_2^2\\ <br />
    &amp;= \|Q\|_2^2 - 2Q(x) + 1
\end{align}</p>

<p>Where $\|Q\|_2$ is the $L_2$-norm of $Q$ defined as $\|Q\|_2 = \sqrt{\mathbb{E}_{y\sim Q}Q(y)}$. The Brier score can be viewed as the kernel score with an extremely narrow kernel: $k(x,y)\rightarrow \delta(x-y)$.</p>

<h1 id="thesphericalkernelscore">The spherical kernel score</h1>

<p>And this brings us to the actual meat in this post. The Brier score has a younger sister, called the spherical score (Good, 1971.<a href="http://amstat.tandfonline.com/doi/abs/10.1198/016214506000001437">Gneiting &amp; Raftery, 2017</a>):</p>

<p>\begin{align}
S_{spherical}(x,Q) &amp;= 1 - \frac{Q(x)}{\|Q\|_2} \\ <br />
    &amp;= 1 - \frac{Q(x)}{\sqrt{\mathbb{E}_{y\sim Q}Q(y)}}
\end{align}</p>

<p>The question arises, if the Brier/quadratic divergence has a kernel analog in MMD, can we also construct a kernel analog to the spherical score and its divergence? The answer is yes, and this is what I call the <em>spherical kernel score</em>.</p>

<p>\begin{align}
S_{spherical,k}(x,Q) &amp;= 1 - \frac{\mu_Q(x)}{\|\mu_Q\|_{\mathcal{H}_k}\|\mu_{\delta_x}\|_{\mathcal{H}_k}} \\ <br />
    &amp;= 1 - \frac{\mathbb{E}_{y\sim Q}k(x,y)}{\sqrt{k(x,x)\mathbb{E}_{y,z\sim Q}k(y,z)}}
\end{align}</p>

<p>And the associated divergence, which I call <em>spherical kernel divergence</em> (SKD, $d_{spherical,k}$) becomes:</p>

<p>\begin{align}
d_{spherical,k}(P,Q) &amp;= 1 - \frac{\langle\mu_P,\mu_Q\rangle_{\mathcal{H}_k}}{\|\mu_Q\|_{\mathcal{H}_k}\|\mu_P\|_{\mathcal{H}_k}}\\ <br />
    &amp;= 1 - \cos(\mu_P,\mu_Q)\\
    &amp; = 1 - \frac{\mathbb{E}_{x\sim P,y\sim Q}k(x,y)}{\sqrt{\mathbb{E}_{x,y\sim P}k(x,y)\mathbb{E}_{x,y\sim Q}k(x,y)}},
\end{align}</p>

<p>where $\langle\mu_P,\mu_Q\rangle_{\mathcal{H}_k}$ denotes inner product between the mean embeddings and $\cos(\mu_P,\mu_Q)$ is defined as</p>

<p>$$
\cos(\mu_P,\mu_Q) = \frac{\langle\mu_P,\mu_Q\rangle_{\mathcal{H}_k}}{\|\mu_P\|_{\mathcal{H}_k}\|\mu_Q\|_{\mathcal{H}_k}}.
$$</p>

<p>While MMD measures the analog of Euclidean distance between mean embeddings, the spherical kernel divergence measures the analog of cosine dissimilarity between them. Just as with MMD and the Brier divergence, the spherical kernel score reduces to the spherical score in the limit of infinitesimal kernel bandwidth $k(x,y)\rightarrow \delta(x-y)$.</p>

<h4 id="randomprojectionsinterpretation">Random projections interpretation</h4>

<p>There is an interesting property of cosine dissimilarity, which is used to approximate cosine distance via <a href="https://en.wikipedia.org/wiki/Locality-sensitive_hashing#Random_projection">locality sensitive hashing (LSH)</a>. This allows us to interpret the SKD as follows:</p>

<p>\begin{align}
d_{spherical,k}(P,Q) &amp;= \mathbb{P}_{f\sim \mathcal{GP}_k} \left[ \operatorname{sign}(\langle f,\mu_P \rangle) \neq \operatorname{sign}(\langle f,\mu_P \rangle) \right]\\ <br />
   &amp;= \mathbb{P}_{f\sim \mathcal{GP}_k} \left[ \operatorname{sign}(\mathbb{E}_{x\sim P}f(x)) \neq \operatorname{sign}(\mathbb{E}_{x\sim Q}f(x))\right]
\end{align}</p>

<p>So, let's say we sample a bunch of smooth scalar test functions $f$ from a Gaussian process with covariance kernel $k$. We take the average of each test function on samples from $P$ as well as on samples from $Q$. Then we take the average of each test function under $P$ and under $Q$ and we look at the probability that the signs differ. So while the MMD cares about the squared difference between $\mathbb{E}_{x\sim P}f(x)$ and $\mathbb{E}_{x\sim Q}f(x)$, the SKD only cares about whether they have the same the same sign or not.</p>

<p>As $f$ are drawn from a Gaussian Process, $\mathbb{E}_{x\sim P}f(x)$ and $\mathbb{E}_{x\sim Q}f(x)$ are jointly Gaussian distributed, with mean $0$ and covariance that depends on $P$ and $Q$ as well as the kernel $k$. Below is a toy figure of such 2D Gaussian, and I shaded the areas where the sign of $\mathbb{E}_{P}f$ and \mathbb{E}_{Q}f$ match. Obviously, the more positively correlated the two random variables are, the higher percentage of probability mass is placed here:</p>

<p><img src="/content/images/2017/03/Quadrant-probabilities--1-.png" alt="" /></p>

<p>Compare this with the MMD which tries to minimise the average squared difference between $\mathbb{E}_{x\sim P}f(x)$ and $\mathbb{E}_{x\sim Q}f(x)$. Both divergences will try to push this Gaussian to be a perfectly correlated, they just differ in how exactly they do it.</p>

<p>If you want to play around with these formulae a little bit more, as homework, try to work exactly what these covariances are (not very hard), and express the spherical kernel score in terms of <a href="http://mathworld.wolfram.com/BivariateNormalDistribution.html">quadrant probabilities of bivariate normal distributions</a>.</p>

<h1 id="summaryandquestions">Summary and questions</h1>

<p>In this post I've (re)introduced the <em>spherical kernel divergence</em> and an associated strictly proper scoring rule for comparing probability distributions. It is related to maximum mean discrepancy, but instead of squared RKHS-distance it measures the cosine distance between the kernel mean embeddings of the two distributions.</p>

<h3 id="whyisthisevenuseful">Why is this even useful?</h3>

<p>Not sure. Not sure it's even useful, but I think it's interesting to think about different divergences one can define based on kernel Hilbert spaces. Unlike MMD, the spherical kernel score is scale independent, in the sense that the value of the divergence remains the same if we multiply either $Q$ or $P$ distributions by a scalar. So technically, the spherical divergence can be computed between two distributions whose normalising constants are intractable. Of course one still has calculate integrals of the form $\int \int P(x) k(x,y) Q(z) dz dx$ and $\int \int Q(x) k(x,y) Q(z) dz dx$ up to a constant. So whether or not this property can be turned into something useful remains to be seen.</p>

<p>Another thing I'm looking for is an ability to optimise the kernel hyperparameters in the divergence. For the MMD this is hard, although there is promising recent progress (<a href="https://arxiv.org/abs/1611.04488">Sutherland et al. 2016</a>). Maybe SKD can unlock new ways in which optimising $k$ can be achieved.</p>

<h3 id="outstandingchallenges">Outstanding challenges</h3>

<p>The obvious question is: How can we approximate the spherical kernel score in an unbiased way, from finite samples? This is a requirement if we want to use it for generative modelling - if we want to do stochastic gradient descent. BTW, hat tip to <a href="https://arxiv.org/abs/1505.03906">Dziugaite et al. (2016)</a> who actually used the unbiased MMD estimate in their version of generative moment matching networks (Eq. (8)) , while <a href="https://arxiv.org/abs/1502.02761">Li et al, (2016)</a> used a biased estimate (Eqn. (3)). I don't actually know what an unbiased estimate of the spherical kernel divergence would look like, so if you do, please leave a comment!</p>
</article>

<div id="comments">
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function () {
            this.page.url = 'http://www.inference.vc/the-spherical-kernel-divergence/';
            this.page.identifier = 102;
            };
        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script'); s.src = '//inference.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

		</main>
		<footer id="footer">
			<section id="footer-message">&copy; 2017 inFERENCe. All rights reserved. Powered by <a href="http://ghost.org" target="_blank">Ghost</a>. <a href="http://github.com/kathyqian/crisp" target="_blank">Crisp</a> theme by <a href="http://kathyqian.com" target="_blank">Kathy Qian</a>.</section>
		</footer>
	<!-- You can safely delete this line if your theme does not require jQuery -->
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
		<script type="text/javascript"     src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
		    tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
		});
		</script>
	</body>

</html>
