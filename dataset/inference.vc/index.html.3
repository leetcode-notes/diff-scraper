<!doctype html>
<html lang="en">
	<head>
	    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
	    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	    <title>Choice of Recognition Models in VAEs: a regularisation view.</title>
	    <meta name="description" content="" />
	    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,700italic,300,700' rel='stylesheet' type='text/css'>
		<link href='http://fonts.googleapis.com/css?family=Bree+Serif' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" type="text/css" href="/assets/styles/crisp.css?v=a4a8b7e06d">
		<link rel="shortcut icon" href="/content/images/2014/Mar/face.png"/>
	    <meta name="HandheldFriendly" content="True" />
	    <meta name="MobileOptimized" content="320" />
	    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
		<!--[if lt IE 9]>
			<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
			<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
		<![endif]-->
	    <link rel="canonical" href="http://www.inference.vc/choice-of-recognition-models-in-vaes-a-regularisation-view/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="http://www.inference.vc/choice-of-recognition-models-in-vaes-a-regularisation-view/amp/" />
    
    <meta property="og:site_name" content="inFERENCe" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Choice of Recognition Models in VAEs: a regularisation view." />
    <meta property="og:description" content="This post is based on a conversation I had recently about the importance of the flexibility of approximate posteriors in variational inference. Many people know that your choice approximate posterior model class in VAEs biases your learning. But not everybody seems to be aware of the full intuition behind this." />
    <meta property="og:url" content="http://www.inference.vc/choice-of-recognition-models-in-vaes-a-regularisation-view/" />
    <meta property="og:image" content="http://www.inference.vc/content/images/2017/03/Screen-Shot-2017-03-28-at-3.11.54-PM.png" />
    <meta property="article:published_time" content="2017-03-28T14:09:05.000Z" />
    <meta property="article:modified_time" content="2017-03-30T08:05:08.000Z" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Choice of Recognition Models in VAEs: a regularisation view." />
    <meta name="twitter:description" content="This post is based on a conversation I had recently about the importance of the flexibility of approximate posteriors in variational inference. Many people know that your choice approximate posterior model class in VAEs biases your learning. But not everybody seems to be aware of the full intuition behind this." />
    <meta name="twitter:url" content="http://www.inference.vc/choice-of-recognition-models-in-vaes-a-regularisation-view/" />
    <meta name="twitter:image" content="http://www.inference.vc/content/images/2017/03/Screen-Shot-2017-03-28-at-3.11.54-PM.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Ferenc Huszar" />
    <meta name="twitter:site" content="@fhuszar" />
    <meta property="og:image:width" content="818" />
    <meta property="og:image:height" content="218" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "inFERENCe",
        "logo": "http://www.inference.vc/content/images/2014/Mar/face.png"
    },
    "author": {
        "@type": "Person",
        "name": "Ferenc Huszar",
        "image": "//www.gravatar.com/avatar/943e71b49d8fa0b3725fa6c82c97163d?d=404",
        "url": "http://www.inference.vc/author/ferenc-huszar/",
        "sameAs": []
    },
    "headline": "Choice of Recognition Models in VAEs: a regularisation view.",
    "url": "http://www.inference.vc/choice-of-recognition-models-in-vaes-a-regularisation-view/",
    "datePublished": "2017-03-28T14:09:05.000Z",
    "dateModified": "2017-03-30T08:05:08.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "http://www.inference.vc/content/images/2017/03/Screen-Shot-2017-03-28-at-3.11.54-PM.png",
        "width": 818,
        "height": 218
    },
    "description": "This post is based on a conversation I had recently about the importance of the flexibility of approximate posteriors in variational inference. Many people know that your choice approximate posterior model class in VAEs biases your learning. But not everybody seems to be aware of the full intuition behind this.",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://www.inference.vc"
    }
}
    </script>

    <meta name="generator" content="Ghost 0.11" />
    <link rel="alternate" type="application/rss+xml" title="inFERENCe" href="http://www.inference.vc/rss/" />
    <script src="//load.sumome.com/" data-sumo-site-id="a378ae33aa68caa37662d339c31c409600c8a85e240c12fceaeb0c70684208c0" async="async"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-96562474-1', 'auto');
  ga('send', 'pageview');

</script>
		<script>
			!function(g,s,q,r,d){r=g[r]=g[r]||function(){(r.q=r.q||[]).push(
			arguments)};d=s.createElement(q);q=s.getElementsByTagName(q)[0];
			d.src='//d1l6p2sc9645hc.cloudfront.net/tracker.js';q.parentNode.
			insertBefore(d,q)}(window,document,'script','_gs');

			_gs('GSN-053712-R');
		</script>
	</head>
	<body class="post-template">
		<header id="header">
			<a id="logo" href="http://www.inference.vc"><img src="/content/images/2014/Mar/face.png" alt="inFERENCe" /></a>
			<h1><a href="http://www.inference.vc">inFERENCe</a></h1>
			<p>posts on machine learning, statistics, opinions on things I&#x27;m reading in the space</p>
			<h6><a href="http://www.inference.vc/about">About</a></h6>
		</header>
		<main id="content">
			<article id="104" class="post">
    <span class="post-stamp">March 28th, 2017</span>
    <h1 class="post-title">Choice of Recognition Models in VAEs: a regularisation view.</h1>
    <p>This post is based on a conversation I had recently about the importance of the flexibility of approximate posteriors in variational inference. Many people know that your choice approximate posterior model class in VAEs biases your learning. But not everybody seems to be aware of the full intuition behind this.</p>

<h2 id="quickrecap">Quick recap</h2>

<h4 id="mostofyoucanskipthis">Most of you can skip this</h4>

<p>I want to make this accessible to people with intermediate knowledge, so I'll start with a recap of what variational inference and learning are for, and how it works.</p>

<p>VI is useful for dealing with latent variable models. Let's assume that for each observation $x$ we assign a hidden variable $z$. Our model $p_\theta$ describes the joint distribution between $x$ and $z$. In such a model, typically:</p>

<ul>
<li>$p_\theta(z)$ is very easy 🐣,</li>
<li>$p_\theta(x\vert z)$ is easy 🐹,</li>
<li>$p_\theta(x, z)$ is easy 🐨,</li>
<li>$p_\theta(x)$ is super-hard 🐍,</li>
<li>$p_\theta(z\vert x)$ is mega-hard 🐲</li>
</ul>

<p>to evaluate. Unfortunately, in machine learning the things we want to calculate are exactly the bad guys, 🐍 and 🐲:</p>

<ul>
<li><em>inference</em> is evaluating $p_\theta(z\vert x)$ (🐲).</li>
<li><em>learning</em> (via maximum likelihood) involves $p_\theta(x)$ (🐍).</li>
</ul>

<p>Variational lower bounds give us ways to approximately perform both inference and maximum likelihood parameter learning, by approximating the posterior 🐲 with a simpler, tamer distribution, $q_\psi(z\vert x)$ (🐰), called the approximate posterior or recognition model. Variational inference and learning involves maximising the evidence lower bound (ELBO):</p>

<p>$$
\operatorname{ELBO}(\theta, \psi) = \sum_n \log p(x_n) - \operatorname{KL}\left[q_\psi(z\vert x_n)\| p_\theta(z\vert x_n)\right]
$$</p>

<p>or</p>

<p>$$
💪 = \sum_n \log 🐍 - \operatorname{KL}[🐰\|🐲]
$$</p>

<p>This expression is still full of 🦂s and 🐲s but the nice thing about it is that it can be written in more convenient forms which only contain the good guys 🐣, 🐹, 🐨 and 🐰:</p>

<p>\begin{align}
💪 &amp;= - \sum_n \mathbb{E}_🐰 \log\frac{🐰}{🐨} + \text{constant} \\
    &amp;= \sum_n \mathbb{E}_🐰 \log 🐹 - \sum_n \mathbb{E}_🐰  \operatorname{KL}[🐰\|🐣]
\end{align}</p>

<p>The first line is what I refer to as the <em>joint contrastive</em> expression, the second I call <em>prior-contrastive</em>. See <a href="http://www.inference.vc/variational-inference-using-implicit-models/">more on this in this series</a>. Both expressions only contain nice, tame distributions and do not need explicit evaluation of either the marginal likelihood 🐍 or the posterior 🐲.</p>

<p>ELBO is - as the name suggests - a lower bound to the model evidence or log likelihood. Therefore, maximising it with respect to $\theta$ and $\psi$ approximates maximum likelihood learning, while you can use the recognition model 🐰 instead of 🐉 to perform tractable approximate inference.</p>

<h2 id="whatistheeffectoftheapproximateclass">What is the effect of the approximate class?</h2>

<p>The evidence lower bound is a function of both the model parameters $\theta$ and the recognition model parameters $\psi$. If you want to reason about how variational learning behaves, we can take the point-wise maximum with respect to $\psi$ to obtain:</p>

<p>$$
ELBO(\theta) = \underbrace{\sum_n \log p_\theta(x_n)}_{\text{marginal likelihood }+} \underbrace{- \min_{\psi} \sum_n \operatorname{KL}[q_\psi(z\vert x_n)\|p_\theta(z\vert x_n)]}_{\text{tameness of posterior}} <br />
$$</p>

<p>Or, with my favourite emojis:</p>

<p>$$
💪(\theta) = \underbrace{\sum_n \log 🐍}_{\text{marginal likelihood }+} \underbrace{- \min_{🐰\in🌍} \sum_n \operatorname{KL}[🐰\|🐲]}_{\text{tameness of posterior}}
$$</p>

<p>The first term is the marginal likelihood, which is what you want to maximise when doing maximum likelihood. The second term is the average <em>tameness</em> of the posterior: $-\min_{🐰\in🌍}\sum_n\operatorname{KL}[🐰\|🐲]$ how well the 🐲 can be approximated by a 🐰. This second term can be seen as data-dependent regulariser which depends on data, as well as on the family $\mathcal{Q}$ from which we can choose our approximate posterior.</p>

<h3 id="isthisabugorafeature">Is this a bug, or a feature?</h3>

<p>You can think of this additional regularizer as either a bug or a feature. Compared with maximum likelihood, the second term biases learning towards models with simpler posteriors. If $q_\psi$ is a factorised Gaussian, then it biases us towards models in which the posterior is approximately factorised, and Gaussian. If our recognition model provides a point estimate or a very narrow Gaussian, it biases us towards models with high mutual information between latents and observations (assuming our prior $p_\theta$ has fixed entropy). The former makes no sense in itself, the latter might actually be a desirable property.</p>

<h4 id="whenitsabugmeaninglessposteriorschosenforconvenience">When it's a bug: meaningless posteriors chosen for convenience</h4>

<p>The choice of variational posteriors is often dictated by analytical convenience: the standard choice is a factorised Gaussian. But it's usually pretty hard to motivate why we want the latent variables to end up <strong>conditionally</strong> independent given observations, or why they would end up conditionally Gaussian, so the tameness regularizer is usually seen as a hindrance, something we'd like to get rid of or decrease the contribution of. One way to do this is to relax the limitations on the posterior and add more flexibility. This motivated research on normalizing flows (<a href="https://arxiv.org/abs/1505.05770">Rezende et al, 2015</a>), inverse autoregressive flows (<a href="https://arxiv.org/abs/1606.04934">Kingma et al, 2016</a>), hybrid MCMC-variational methods (<a href="https://arxiv.org/abs/1410.6460">Salimans et al, 2014</a>), operator variational inference (<a href="https://arxiv.org/abs/1610.09033">Ranganath et al, 2016</a>) and adversarial variational Bayes (see <a href="http://www.inference.vc/variational-inference-using-implicit-models/">this series of posts and references therein</a>). You can understand these techniques as aiming to decrease the relative contribution of the tameness regularizer by relaxing the restrictions on the recognition model class. In other words, instead of 🐰 they use a 🐊 to approximate 🐲.</p>

<h4 id="whenitsafeaturemeaningfulposteriors">When it's a feature: meaningful posteriors</h4>

<p>In some cases it may be more intuitive to think about your posterior, than to think about the forward model or generative process. Take, for example, the case of a latent variable image model in which positive integer hidden variables are meant to describe the number of certain types of objects in the image. It makes sense to reason about what you want your approximate posterior to do in this case: First, you want to have a guess about the total number of objects in the image, then, conditioned on this total number, you want to have some distribution over the numbers for each class - all while keeping the sum constant - such as a multinomial. So it makes sense to choose your posterior to be a mixture of multinomials (e.g. a negative multinomial distribution, but probably with a less restrictive mixing distribution). This introduces some non-trivial conditional dependence between the variables, but these dependences are the right kind, the kind you actually expect the posterior to possess.</p>

<p>If you choose your approximate posterior so that it makes sense to you, the tameness regularizer actually is your friend. You can think of it as a way to enforce your prior preferences over models: if you think posterior inference in the real world should work a particular way - then ELBO will respect that preference and favour models which work that way.</p>

<h3 id="bayesianperspectivetheposteriortamenessprior">Bayesian perspective: the posterior tameness prior</h3>

<p>From a Bayesian perspective, you can also think of maximising ELBO as performing <em>maximum a-posteriori</em> (MAP) model selection with a <em>data-dependent</em> prior over model parameters:</p>

<p>$$
p_{\mathcal{Q},\mathcal{D}}(\theta) \propto e^{-\min_{q\sim \mathcal{Q}} \sum_n \operatorname{KL}[q(z\vert x_n)\|p_\theta(z\vert x_n)]}, <br />
$$</p>

<p>where $\mathcal{Q}$ is the model class, $\mathcal{D}$ is the dataset.</p>

<p>Firstly, this prior depends on data and in this sense many would argue it's not a truly Bayesian interpretation. But then, any time you optimise hyperparameters, you essentially end up with a data-dependent prior so the question of data-dependent priors is a matter of taste. Secondly, $p_{\mathcal{Q},\mathcal{D}}$ may not even define a proper probability distribution over $\theta$. It may be that it doesn't have a finite normalisation constant when you integrate over $\theta\in\Theta$. For example, if $\mathcal{Q}$ is the set of all conditional distributions, then the prior is a uniform which is only proper over a finite parameter space $\Theta$.</p>

<p>But if you accept this $p_{\mathcal{Q},\mathcal{D}}$ as your prior over models, then it gives you a way to think about designing your recognition model. </p>

<blockquote>
  <p>you should think about choosing the recognition model family $\mathcal{Q}$ the same way you'd think about choosing a hyperprior in a hierarchical Bayesian model</p>
</blockquote>

<p>Often, people try to make $\mathcal{Q}$ as flexible as possible, which moves the prior towards a uniform - a little bit resembling <em>objective Bayes</em>. But you can also be a <em>subjective Bayesian</em> and use this intuition to restrict $\mathcal{Q}$ in a meaningful way that captures your prior preferences. A nice example of this would be to use probabilistic programs or parametric heuristics as recognition models.</p>
</article>

<div id="comments">
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function () {
            this.page.url = 'http://www.inference.vc/choice-of-recognition-models-in-vaes-a-regularisation-view/';
            this.page.identifier = 104;
            };
        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script'); s.src = '//inference.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

		</main>
		<footer id="footer">
			<section id="footer-message">&copy; 2017 inFERENCe. All rights reserved. Powered by <a href="http://ghost.org" target="_blank">Ghost</a>. <a href="http://github.com/kathyqian/crisp" target="_blank">Crisp</a> theme by <a href="http://kathyqian.com" target="_blank">Kathy Qian</a>.</section>
		</footer>
	<!-- You can safely delete this line if your theme does not require jQuery -->
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
		<script type="text/javascript"     src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
		    tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
		});
		</script>
	</body>

</html>
